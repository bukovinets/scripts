# Proxmox Dynamic Backup Automation

This repository contains a suite of Bash and Python scripts designed to automate Proxmox VE (PVE) backup jobs. The primary goal is to **dynamically select only "Running" VMs** for backup execution, ignoring stopped VMs to save I/O and storage, while respecting cluster node restrictions and VM migrations.

## üöÄ Features

* **Skip Stopped VMs:** Automatically excludes stopped VMs from backup jobs to prevent unnecessary full-disk reads.
* **Cluster & Migration Aware:** Detects if a VM has migrated to a different node. If a backup job is restricted to a specific node, the script correctly includes/excludes VMs based on their current physical location.
* **Dynamic Scheduling:** The `manager.sh` script runs hourly to detect changes in Proxmox Backup Schedules and automatically updates the system crontab to trigger the updater 10 minutes (configurable) before the job starts.
* **Integrated Notifications:** Parses native Proxmox notification configurations (`/etc/pve/notifications.cfg`) to send success/error emails via SMTP using the existing root credentials.
* **Detailed Logging:** Maintains a persistent log file (`automation.log`) and sends "Trace-Level" execution logs in email bodies for easy debugging.

## üìÇ File Structure

* **`manager.sh`** (The Scheduler): Reads PVE backup jobs via API, calculates trigger times, and updates the root `crontab`.
* **`updater.sh`** (The Worker): Triggered by cron. Fetches running VMs, filters by node, and updates the specific PVE Backup Job definition via `pvesh`.
* **`common.sh`** (Shared Library): Contains logging logic, Python SMTP notification logic, and shared configuration variables.

## üìã Prerequisites

* Proxmox VE Cluster (Tested on PVE 8.x).
* Python 3 installed on the host (Standard on PVE).
* Configured SMTP settings in **Datacenter -> Notifications**.
* Root access to the Proxmox node.

## üõ†Ô∏è Installation

1.  **Create Directory**
    Create a directory to host the scripts (recommended: `/root/backup-scripts/`):
    ```bash
    mkdir -p /root/backup-scripts/
    ```

2.  **Copy Files**
    Upload `manager.sh`, `updater.sh`, and `common.sh` to this directory.

3.  **Set Permissions**
    Make the scripts executable:
    ```bash
    chmod +x /root/backup-scripts/*.sh
    ```

4.  **Initial Run**
    Run the manager manually to initialize the state file and populate the crontab:
    ```bash
    /root/backup-scripts/manager.sh
    ```

5.  **Verify Cron**
    Check that the cron jobs have been generated:
    ```bash
    crontab -l
    ```
    You should see a block delimited by `# --- AUTOGENERATED BACKUP UPDATER START ---`.

6.  **Schedule the Manager**
    Add the *only* manual cron entry required to keep the system in sync. Run `crontab -e` and add this line to run hourly:
    ```cron
    0 * * * * /root/backup-scripts/manager.sh
    ```

## ‚öôÔ∏è Configuration

Global settings can be modified in **`common.sh`**:

```bash
# How many minutes BEFORE the backup schedule should the updater run?
# Default: 10
PADDING_MINUTES=10
```

> **Note:** If deploying on multiple nodes in a cluster, it is recommended to stagger the `PADDING_MINUTES` (e.g., 10 on Node A, 15 on Node B) to prevent API collisions if multiple nodes try to update the same cluster-wide job simultaneously.

## üß† Logic Flow

### 1. The Manager (`manager.sh`)
* Runs hourly.
* Queries `pvesh get /cluster/backup` to find all enabled `vzdump` jobs.
* Parses the `schedule` (HH:MM) using an embedded Python script.
* Subtracts `PADDING_MINUTES` from the schedule time.
* Writes entries to the root `crontab` to run `updater.sh <JOB_ID>` at the calculated time.

### 2. The Updater (`updater.sh`)
* Runs exactly X minutes before the backup job.
* Fetches the configuration for the specific `JOB_ID`.
* **Node Filtering Logic:**
    * It fetches **ALL** cluster resources.
    * It filters for VMs where `status == 'running'`.
    * It checks the Backup Job's `node` restriction:
        * If the job is restricted to Node A, it only includes VMs currently running on Node A.
        * If the job has no restriction (Cluster-wide), it includes all running VMs.
* Updates the Backup Job definition using `pvesh set ... --vmid <LIST>`.

## üîç Logging & Notifications

* **Local Log:** All actions are logged to `/root/backup-scripts/automation.log`.
* **Email:**
    * Emails are sent using the SMTP server configured in Proxmox (`/etc/pve/notifications.cfg`).
    * It attempts to resolve the `root@pam` email address automatically.
    * **Interactive vs Cron:** The scripts detect if they are running in a terminal (TTY). If running manually, they output to console. If running via Cron, they are silent to prevent duplicate system emails, sending only the custom Python-formatted HTML email.

## ‚ö†Ô∏è Disaster Recovery

Since this script modifies the "Selected VMs" list dynamically:
* If the script fails to run (e.g., server down), the backup job will execute using the **last known list** of VMs.
* **Recommendation:** Ensure the `manager.sh` cron job is active on at least one node in the cluster.